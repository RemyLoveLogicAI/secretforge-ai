#!/bin/bash
# SecretForge CLI v1.1.0 - Fixed datetime deprecation warning

set -euo pipefail

VERSION="1.1.0"
VAULT_DIR="$HOME/.secretforge"
CONFIG_FILE="$VAULT_DIR/config.json"
MASTER_KEY_FILE="$VAULT_DIR/.key"
LOG_FILE="$VAULT_DIR/evolution.log"

R='\033[0;31m'; G='\033[0;32m'; Y='\033[1;33m'; B='\033[0;34m'; C='\033[0;36m'; NC='\033[0m'

log_evolution() {
  echo "[$(date -u +%Y-%m-%dT%H:%M:%SZ)] $1" >> "$LOG_FILE"
}

ensure_vault() {
  if [ ! -f "$CONFIG_FILE" ]; then
    mkdir -p "$VAULT_DIR"
    chmod 700 "$VAULT_DIR"
    openssl rand -hex 64 > "$MASTER_KEY_FILE"
    chmod 600 "$MASTER_KEY_FILE"
    cat > "$CONFIG_FILE" <<EOF
{
  "version": "$VERSION",
  "created": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "evolution_level": 0,
  "auto_discovery": true,
  "ai_suggestions": true,
  "platforms": {
    "vercel": { "enabled": true, "auto_sync": false },
    "railway": { "enabled": true, "auto_sync": false },
    "cloudflare": { "enabled": true, "auto_sync": false },
    "github": { "enabled": true, "auto_sync": false }
  },
  "secrets": {}
}
EOF
    touch "$LOG_FILE"
    log_evolution "Vault initialized - Evolution begins"
  fi
}

store_secret() {
  local KEY="$1" VALUE="$2" SOURCE="${3:-manual}"
  [ -z "$KEY" ] && { echo "Key required" >&2; return 1; }
  [ -z "$VALUE" ] && { echo "Value required" >&2; return 1; }

  ensure_vault
  ENCRYPTED=$(echo -n "$VALUE" | openssl enc -aes-256-cbc -a -salt -pbkdf2 -iter 100000 -pass file:"$MASTER_KEY_FILE" 2>/dev/null | tr -d '\n')
  [ -z "$ENCRYPTED" ] && { echo "Encryption failed" >&2; return 1; }

  python3 <<PYEOF
import json, sys
from datetime import datetime, timezone

cfg = "$CONFIG_FILE"
with open(cfg) as f:
    data = json.load(f)
data.setdefault("secrets", {})["$KEY"] = {
    "encrypted": True,
    "source": "$SOURCE",
    "updated": datetime.now(timezone.utc).isoformat().replace('+00:00', 'Z'),
    "value": "$ENCRYPTED"
}
data["evolution_level"] = data.get("evolution_level", 0) + 1
with open(cfg, "w") as f:
    json.dump(data, f, indent=2)
PYEOF

  log_evolution "Stored: $KEY (source: $SOURCE)"
}

get_secret() {
  local KEY="$1"
  ensure_vault
  read -r ENCRYPTED ENCRYPTED_FLAG <<<"$(python3 <<PYEOF
import json, sys
try:
    with open("$CONFIG_FILE") as f:
        data = json.load(f)
    val = data.get("secrets", {}).get("$KEY")
    if not val:
        sys.exit(1)
    print(val.get('value',''), val.get('encrypted', True))
except Exception:
    sys.exit(1)
PYEOF
  )"
  [ -z "${ENCRYPTED:-}" ] && { echo ""; return 1; }
  if [ "$ENCRYPTED_FLAG" = "True" ] || [ "$ENCRYPTED_FLAG" = "true" ]; then
    echo "$ENCRYPTED" | openssl enc -aes-256-cbc -d -a -pbkdf2 -iter 100000 -pass file:"$MASTER_KEY_FILE" 2>/dev/null
  else
    echo "$ENCRYPTED"
  fi
}

list_secrets() {
  ensure_vault
  python3 <<PYEOF
import json
from datetime import datetime, timezone
with open("$CONFIG_FILE") as f:
    cfg = json.load(f)
secrets = cfg.get("secrets", {})
if not secrets:
    print("  No secrets stored yet.")
else:
    print(f"{'Key':<35} {'Source':<20} {'Updated'}")
    print("─"*80)
    for k,v in secrets.items():
        print(f"{k:<35} {v.get('source','unknown'):<20} {v.get('updated','')[:10]}")
    print(f"\nTotal: {len(secrets)} | Evolution Level: {cfg.get('evolution_level',0)}")
PYEOF
}

export_env() {
  ensure_vault
  CONFIG_PATH="$CONFIG_FILE" python3 <<'PYEOF'
import json, os
cfg = os.environ["CONFIG_PATH"]
with open(cfg) as f:
    data = json.load(f)
print("# SecretForge Environment Export")
print("# Source this file: source <(secretforge export)")
for key in data.get('secrets', {}):
    print(f'export {key}="$(secretforge get {key})"')
PYEOF
}

show_help() {
  echo "SecretForge CLI v$VERSION"
  echo "Usage: secretforge [init|set|get|list|export]"
  echo ""
  echo "Commands:"
  echo "  init              Initialize the vault"
  echo "  set <key> <val>   Store a secret"
  echo "  get <key>         Retrieve a secret"
  echo "  list              List all secrets"
  echo "  export            Export as shell script"
  echo "  help              Show this help"
}

COMMAND="${1:-help}"
case "$COMMAND" in
  init)
    ensure_vault
    echo "✅ Vault ready at $VAULT_DIR"
    ;;
  set|store)
    store_secret "$2" "$3" "manual" && echo "✅ Secret stored"
    ;;
  get)
    get_secret "$2"
    ;;
  list|ls)
    list_secrets
    ;;
  export)
    export_env
    ;;
  help|--help|-h)
    show_help
    ;;
  *)
    echo "❌ Unknown command: $COMMAND" >&2
    echo "Use 'secretforge help' for usage" >&2
    exit 1;
    ;;
esac

log_evolution "Command executed: $COMMAND"